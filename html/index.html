﻿<!DOCTYPE html>
<html lang="cn">
<head>
	<meta charset="utf-8">
	<title>万硕自动贩卖机</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width,inital-scale=1.0"><!--自适应-->
	<script type="text/javascript" src="../js/main.js" charset="gb2312"></script>
	<script type="text/javascript" src="../js/Chart.js"></script>
	<script type="text/javascript" src="../js/Chart.min.js"></script>
	<script type="text/javascript" src="../js/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="../js/highcharts.js"></script>
	<script type="text/javascript" src="../js/exporting.js"></script>
	<script type="text/javascript" src="../js/export-data.js"></script>
	<link rel="stylesheet" href="../css/main.css" type="text/css">
	<link rel="icon" type="../image/x-icon" href="images/favicon.ico">
	<script type="text/javascript">
		var i = 0;
		var o;
		function nice() {
			var now = new Date();
			var h = now.getHours();
			var m = now.getMinutes();
			var s = now.getSeconds();
			h = checktime(h);
			s = checktime(s);
			m = checktime(m);
			document.getElementById('text').innerHTML = h + ":" + m + ":" + s;
			t = setTimeout('nice()', 1000);
		}
		function checktime(n) {
			if (n < 10) {
				n = "0" + n;
			}
			return n;
		}
		//雪碧
		function xuebi_addBuy(){
			var total = parseInt(document.getElementById("xuebi_kucun").innerText)
			var current = parseInt(document.getElementById("xuebi_number").innerText)
			if(current<total){
				current++;
				document.getElementById("xuebi_number").innerText = current
			}
			else{
				alert("没有更多的商品了")
			}
			calTotalMoney()
		}

		function xuebi_subBuy(){
			var total = parseInt(document.getElementById("xuebi_kucun").innerText)
			var current = parseInt(document.getElementById("xuebi_number").innerText)
			if(current != 0){
				current--;
				document.getElementById("xuebi_number").innerText = current
			}
			calTotalMoney()
		}
		//可乐
		function kele_addBuy(){
			var total = parseInt(document.getElementById("kele_kucun").innerText)
			var current = parseInt(document.getElementById("kele_number").innerText)
			if(current<total){
				current++;
				document.getElementById("kele_number").innerText = current
			}
			else{
				alert("没有更多的商品了")
			}
			calTotalMoney()
		}

		function kele_subBuy(){
			var total = parseInt(document.getElementById("kele_kucun").innerText)
			var current = parseInt(document.getElementById("kele_number").innerText)
			if(current != 0){
				current--;
				document.getElementById("kele_number").innerText = current

			}
			calTotalMoney()
		}
		//------------------------------------------------------------------------------
		//计算总金额
		function calTotalMoney(){
			console.log("Cal Money")
			var totalMoney = 0 
			//雪碧
			var xuebi_current = parseInt(document.getElementById("xuebi_number").innerText)
			var xuebi_danjia = parseFloat(document.getElementById("xuebi_danjia").innerText)
			totalMoney = xuebi_current*xuebi_danjia +totalMoney
			//雪碧
			var kele_current = parseInt(document.getElementById("kele_number").innerText)
			var kele_danjia = parseFloat(document.getElementById("kele_danjia").innerText)
			totalMoney = kele_current*kele_danjia +totalMoney

			document.getElementById("totalMoney").innerText = totalMoney
		}

		//支付
		function payMoney(){
			var money = parseFloat(document.getElementById("totalMoney").innerText)
			if(money != 0){
				payFinish()
			}
			else{
				alert("请选择商品后支付")
			}
		}

		//支付取消
		function payCancel(){
			var payPage = document.getElementById("paypage")
			payPage.style.display = "none"
			payPage = document.getElementById("ctr-body")
			payPage.style.display = "inherit"
		}

		//支付完成
		function payFinish(){
			var info={}
			var xuebi_current = parseInt(document.getElementById("xuebi_number").innerText)
			var kele_current = parseInt(document.getElementById("kele_number").innerText)
			info.xuebi = xuebi_current;
			info.kele = kele_current;
			
			$.get("../cgi-bin/pay.cgi", info, function (data, status) {
			if (status == "success") {
				console.log("recv",data);
				if(data == 0){
					alert("购物失败")
				}
				else{
					alert("购买成功")
				}
			}
			else {
				alert("购买失败")
			}
			});
			// location.reload()
		}
		
		//获取列表信息
		function load(){
			$.get("../cgi-bin/list.cgi", "", function (data, status) {
			if (status == "success") {
				console.log("recv",data);
				var info = JSON.parse(data)
				document.getElementById("xuebi_kucun").innerText =info.xuebi
				document.getElementById("kele_kucun").innerText =info.kele  

			}
			else {
				alert("加载失败")
			}
			});
		}

	</script>
</head>
<body onload="load()">
	<dvi id="body">
		<div id="head">
			<iframe id="wea" width="420" scrolling="no" height="60" frameborder="0" allowtransparency="true" src="//i.tianqi.com/index.php?c=code&id=12&icon=1&num=5&site=12"></iframe>
			<span id="head-title">万硕自动贩卖机</span>
			<span id="text" text-align="center" style="
					text-align: center;
					color: #ff0000;
					font-size: 26px;
					float: right;
					position: relative;
					right: 229px;
					top: 10px;
				">
			</span>
		</div>
		<!--主体-->
		<div id="ctr-body">
			
			<!--雪碧部分-->
			<div class="shangpin-div" id="xuebi-div">
				<p  class="shangpin-titile" id="xuebi_title"><span>雪碧</span></p>
				<img src="../images/xuebi.jpeg" alt="" width="120" height="80" id="xuebi-img">
				<P >金额：<span id="xuebi_danjia">2.5</span>元</P>
				<P >库存：<span id="xuebi_kucun">10</span>个</P>
				<p>数量：<button onclick="xuebi_subBuy()">-</button><span id="xuebi_number">0</span><button onclick="xuebi_addBuy()">+</button></p>
			</div>
			<!--可乐部分-->
			<div class="shangpin-div" id="kele-div">
				<p class="shangpin-titile" id="kele-title"><span>可乐</span></p>
				<img src="../images/kele.jpg" alt="" width="120" height="80" id="kele-img">
				<P >金额：<span id="kele_danjia">3</span>元</P>
				<P >库存：<span id="kele_kucun">15</span>个</P>
				<p>数量：<button onclick="kele_subBuy()">-</button><span id="kele_number">0</span><button onclick="kele_addBuy()">+</button></p>
			</div>
			<!-- 结算行 -->
			<div id="moneydiv">
				<p>总金额：<span id="totalMoney">0</span>元<button onclick="payMoney()" >支付</button></p>
			</div>
		</div>
		
		<!-- 支付页面 -->
		<div id="paypage">
			<p>请等待</p>
			<img src="../images/kele.jpg" alt="">
			<p><button onclick="payCancel()">放弃支付</button><button onclick="payFinish()">已完成支付</button></p>
		</div>
	</dvi>
</body>
</html>													 
														 